import { makeStreamCompletionOrig } from "./makeStreamCompletionOrig"
import { marked } from "marked"
import { markedTerminal } from "marked-terminal"

/**
 * Detects and cleans invalid markdown code blocks in content using marked library
 * @param content The content to check for invalid markdown code blocks
 * @returns Cleaned content with invalid trailing backticks removed
 */
const cleanInvalidMarkdownCodeBlocks = (content: string, chunk): string => {
  // Check if content ends with '```' but doesn't contain a proper closing '\n```'
  // This indicates an incomplete/invalid markdown code block

  // Use marked to verify if this is indeed an invalid markdown
  // console.log(chunk)
  try {
    // Try to parse the content with marked
    const tokens = marked.lexer(content)

    // Check if there's an unclosed code block at the end
    const lastToken = tokens[tokens.length - 1]
    if (lastToken && lastToken.type === "code") {
      // This is indeed an unclosed code block, remove the trailing backticks
      if (chunk.finish_reason !== "done") {
        if (content.endsWith("```")) {
          {
            return content.slice(0, -3).trim()
          }
        }
      }
    }
  } catch (error) {
    // If marked parsing fails, fall back to simple detection
    console.warn("Marked parsing failed, falling back to simple detection:", error)
    return content.slice(0, -3)
  }
  return content
}

const main = async () => {
  const response = await fetch("https://gemini.google.com/_/BardChatUi/data/assistant.lamda.BardFrontendService/StreamGenerate?bl=boq_assistant-bard-web-server_20251125.06_p0&f.sid=-3323142058221652732&hl=id&_reqid=4645571&rt=c", {
    headers: {
      accept: "*/*",
      "accept-language": "en-US,en;q=0.9,id;q=0.8",
      "cache-control": "no-cache",
      "content-type": "application/x-www-form-urlencoded;charset=UTF-8",
      pragma: "no-cache",
      priority: "u=1, i",
      "sec-ch-ua": '"Chromium";v="142", "Google Chrome";v="142", "Not_A Brand";v="99"',
      "sec-ch-ua-arch": '"x86"',
      "sec-ch-ua-bitness": '"64"',
      "sec-ch-ua-form-factors": '"Desktop"',
      "sec-ch-ua-full-version": '"142.0.7444.176"',
      "sec-ch-ua-full-version-list": '"Chromium";v="142.0.7444.176", "Google Chrome";v="142.0.7444.176", "Not_A Brand";v="99.0.0.0"',
      "sec-ch-ua-mobile": "?0",
      "sec-ch-ua-model": '""',
      "sec-ch-ua-platform": '"Windows"',
      "sec-ch-ua-platform-version": '"19.0.0"',
      "sec-ch-ua-wow64": "?0",
      "sec-fetch-dest": "empty",
      "sec-fetch-mode": "cors",
      "sec-fetch-site": "same-origin",
      "x-browser-channel": "stable",
      "x-browser-copyright": "Copyright 2025 Google LLC. All Rights reserved.",
      "x-browser-validation": "Aj9fzfu+SaGLBY9Oqr3S7RokOtM=",
      "x-browser-year": "2025",
      "x-client-data": "CIm2yQEIo7bJAQipncoBCJ/eygEIkqHLAQiFoM0BCOjkzgEIlozPAQiBkc8BCKCYzwEI9JjPAQjAmc8BCNOZzwEI+J3PAQjDns8BCNOezwEYsobPARiXk88B",
      "x-goog-ext-525001261-jspb": '[1,null,null,null,"9ec249fc9ad08861",null,null,0,[4]]',
      "x-goog-ext-73010989-jspb": "[0]",
      "x-same-domain": "1",
      cookie:
        "HSID=AimKvuReXVS_Y9zJ6; SSID=AGViNGGUMGE7k6DHZ; APISID=xLNRbKlzk3XBp3-k/A48lKNq417sFQOH07; SAPISID=70LF_i_n6LbDeh-A/ALeOo9Xw33St8xH6u; __Secure-1PAPISID=70LF_i_n6LbDeh-A/ALeOo9Xw33St8xH6u; __Secure-3PAPISID=70LF_i_n6LbDeh-A/ALeOo9Xw33St8xH6u; SID=g.a0003wiHby4qh3XexHVFsCKPosXNuokvAPnmFYc7QnWy4j0KOUAs1a474MlTIMO2JpTVRo7FbAACgYKAeUSARESFQHGX2Mi7bcsSwzlG7YsYtBhvXaeCBoVAUF8yKrzjppvMC5b3m33mZ-cN6d70076; __Secure-1PSID=g.a0003wiHby4qh3XexHVFsCKPosXNuokvAPnmFYc7QnWy4j0KOUAsOfurMxOQR5WBxA4te5zg9AACgYKAQQSARESFQHGX2Mi4DHBODAJSHFthWRqdP7tnBoVAUF8yKoDjxIZMEXn_l99CrZCLmzs0076; __Secure-3PSID=g.a0003wiHby4qh3XexHVFsCKPosXNuokvAPnmFYc7QnWy4j0KOUAszJ2znN4wNrtHKxgnfD-02QACgYKAXgSARESFQHGX2MiSt43px07GncryteFbd0uPRoVAUF8yKqd3EUS509G-w6yUZmaYnrG0076; _gcl_au=1.1.582418671.1764158868; _ga=GA1.1.1882667089.1764158869; AEC=AaJma5sD5kxGhBwT_3CI8LeYwdpd2Usdm12Es4ZfHVuR5cBO1Ij62dPTL78; NID=526=S2S4FxTlEPJ9jvrORL49sEaZmf7gfgO9gD7WPtJZsItfVMcczQcu8T8aEM87OVz3iIcy1IOlS8HtimXN9imS4zG4WQXAE-goibz-yUuCWnEXSk6U9Ny1Gl9pq3UqLq7EqfxPdKgpBOku0_6D0EZIIOGoMgud5U-VDcbVXK5HnKZqjVvaqdT82GWkwGGEy93rCXRQi821d6uX88asasI-BWqke2YmNE2Lb2Miw4fgMQlwCb5FIx7a5hzU1UBlc9GM4pnQYIQCikI0HCG09DbbMvgTIWKbKj3rSLkKZLCwe3_Y9RSvI1sEo_BSbif_Eu9apUwT6fCNuwUDvIIoyPCJRoFrdfkE1BcApUS83ij04A51vx-kZbP8o8712PXTI4fdDzWX8J3eOAg22N4sb4fPl4BP33TAA3QgxgJkupFuXn9dGDjm20hsY64soj6aqs4qsxf_k01LsCKuGgdIwJ7E0YYagIIsKbnK5B7oog-0RcvWvGCAjBJGYlKWxW1GFD5KKN61J67rY__PFY_wjCwwP2-0Cz_u7raNc1rrOl_EIgXYXfsu0DfJbvyEqFGcYQeEcuYNfGf3ONId-qqi7IFn16TL_JjVuaPxSGV3OcotrVoJjXoteSofuBbV9410Pa0DxQ94zAlqNUdIS3j6d-BHAZueWjEKwYw1jjFZF3VoRDl87HhQp_kxMiRB20c_9kuyqFFEZCbFecqmMYOvWW1tVPt6X6LCdISLOvW-udL9hAntUybH5Q-dbGk5qqVX0TTXdyY; SEARCH_SAMESITE=CgQIw58B; __Secure-1PSIDTS=sidts-CjcBwQ9iIxDb2lQQHhS6ESj9QpJipWxrWTdsNCk36h9XYk0UBbL7BFQX2b4zPfzge7v9JOFS3VEUEAA; __Secure-1PSIDRTS=sidts-CjcBwQ9iIxDb2lQQHhS6ESj9QpJipWxrWTdsNCk36h9XYk0UBbL7BFQX2b4zPfzge7v9JOFS3VEUEAA; __Secure-3PSIDTS=sidts-CjcBwQ9iIxDb2lQQHhS6ESj9QpJipWxrWTdsNCk36h9XYk0UBbL7BFQX2b4zPfzge7v9JOFS3VEUEAA; __Secure-3PSIDRTS=sidts-CjcBwQ9iIxDb2lQQHhS6ESj9QpJipWxrWTdsNCk36h9XYk0UBbL7BFQX2b4zPfzge7v9JOFS3VEUEAA; _ga_WC57KJ50ZZ=GS2.1.s1764220394$o7$g1$t1764222336$j9$l0$h0; _ga_BF8Q35BMLM=GS2.1.s1764220395$o7$g1$t1764222336$j9$l0$h0; SIDCC=AKEyXzWxnsIA04pL2oGa46Ffmlyzk63WS9Vztcdioje2PwkJ2YkXXRdQ3rjNkvZlHT6c35SaIBQ; __Secure-1PSIDCC=AKEyXzUMsz1f4uqLxiYHjyJAYuN7Wojtur5OHEtIE1k72GyoUYiu12SQR5KvINlvSozEzngG5w; __Secure-3PSIDCC=AKEyXzVmat8UcJ3o4xxwWFyZel_irecxr24Hrv4Q8f42__qVgFLaCwJ0j4vwbYD8nIxt6zcTfis",
      Referer: "https://gemini.google.com/",
    },
    body: "f.req=%5Bnull%2C%22%5B%5B%5C%22%23%23%23%20Task%3A%5C%5CnSuggest%203-5%20relevant%20follow-up%20questions%20or%20prompts%20that%20the%20user%20might%20naturally%20ask%20next%20in%20this%20conversation%20as%20a%20**user**%2C%20based%20on%20the%20chat%20history%2C%20to%20help%20continue%20or%20deepen%20the%20discussion.%5C%5Cn%23%23%23%20Guidelines%3A%5C%5Cn-%20Write%20all%20follow-up%20questions%20from%20the%20user%E2%80%99s%20point%20of%20view%2C%20directed%20to%20the%20assistant.%5C%5Cn-%20Make%20questions%20concise%2C%20clear%2C%20and%20directly%20related%20to%20the%20discussed%20topic(s).%5C%5Cn-%20Only%20suggest%20follow-ups%20that%20make%20sense%20given%20the%20chat%20content%20and%20do%20not%20repeat%20what%20was%20already%20covered.%5C%5Cn-%20If%20the%20conversation%20is%20very%20short%20or%20not%20specific%2C%20suggest%20more%20general%20(but%20relevant)%20follow-ups%20the%20user%20might%20ask.%5C%5Cn-%20Use%20the%20conversation's%20primary%20language%3B%20default%20to%20English%20if%20multilingual.%5C%5Cn-%20Response%20must%20be%20a%20JSON%20array%20of%20strings%2C%20no%20extra%20text%20or%20formatting.%5C%5Cn%23%23%23%20Output%3A%5C%5CnJSON%20format%3A%20%7B%20%5C%5C%5C%22follow_ups%5C%5C%5C%22%3A%20%5B%5C%5C%5C%22Question%201%3F%5C%5C%5C%22%2C%20%5C%5C%5C%22Question%202%3F%5C%5C%5C%22%2C%20%5C%5C%5C%22Question%203%3F%5C%5C%5C%22%5D%20%7D%5C%5Cn%23%23%23%20Chat%20History%3A%5C%5Cn%3Cchat_history%3E%5C%5CnUSER%3A%20hi%5C%5CnASSISTANT%3A%20Hello!%20How%20can%20I%20help%20you%20today%3F%5C%5CnUSER%3A%20terjemahkan%3A%5C%5Cn%23%23%20Service%20Workers%5C%5CnEin%20_Service%20Worker_%20fungiert%20als%20eine%20Art%20Proxy%2C%20der%20sich%20zwischen%20eine%20oder%20mehrere%20Webseiten%20im%20Browser%20und%20den%20Server%20setzt.%20Da%20ein%20Service%20Worker%20nicht%20nur%20mit%20einer%20einzelnen%20Webseite%2C%20sondern%20potenziell%20mit%20mehreren%20Seiten%20verbunden%20ist%2C%20%C3%A4hnelt%20er%20eher%20einem%20Shared%20Worker%20als%20einem%20Dedicated%20Worker.%20Sie%20werden%20sogar%20auf%20die%20gleiche%20Weise%20%5C%5C%5C%22verschl%C3%BCsselt%5C%5C%5C%22%20wie%20Shared%20Worker.%20Aber%20ein%20Service%20Worker%20kann%20im%20Hintergrund%20laufen%2C%20auch%20wenn%20eine%20Seite%20nicht%20unbedingt%20noch%20ge%C3%B6ffnet%20ist.%20Aus%20diesem%20Grund%20kann%20ein%20Dedicated%20Worker%20mit%20einer%20Seite%2C%20ein%20Shared%20Worker%20mit%20einer%20oder%20mehreren%20Seiten%20und%20ein%20Service%20Worker%20mit%20null%20oder%20mehr%20Seiten%20verbunden%20sein.%20Ein%20Shared%20Worker%20entsteht%20jedoch%20nicht%20auf%20magische%20Weise%20aus%20dem%20Nichts.%20Stattdessen%20muss%20zuerst%20eine%20Webseite%20ge%C3%B6ffnet%20werden%2C%20um%20den%20Shared%20Worker%20zu%20installieren.%5C%5CnService%20Worker%20sind%20in%20erster%20Linie%20f%C3%BCr%20die%20Cache-Verwaltung%20einer%20Website%20oder%20einer%20einseitigen%20Anwendung%20gedacht.%20Sie%20werden%20in%20der%20Regel%20aufgerufen%2C%20wenn%20Netzwerkanfragen%20an%20den%20Server%20gesendet%20werden%2C%20wobei%20ein%20Event-Handler%20im%20Service%20Worker%20die%20Netzwerkanfrage%20abf%C3%A4ngt.%20Der%20Ruhm%20des%20Service%20Workers%20besteht%20darin%2C%20dass%20er%20zwischengespeicherte%20Daten%20zur%C3%BCckgeben%20kann%2C%20wenn%20ein%20Browser%20eine%20Webseite%20anzeigt%2C%20aber%20der%20Computer%2C%20auf%20dem%20er%20l%C3%A4uft%2C%20keinen%20Netzwerkzugang%20mehr%20hat.%20Wenn%20der%20Service%20Worker%20die%20Anfrage%20erh%C3%A4lt%2C%20kann%20er%20einen%20Cache%20nach%20einer%20zwischengespeicherten%20Ressource%20durchsuchen%2C%20eine%20Anfrage%20an%20den%20Server%20stellen%2C%20um%20eine%20Art%20von%20Ressource%20zu%20erhalten%2C%20oder%20sogar%20eine%20umfangreiche%20Berechnung%20durchf%C3%BChren%20und%20das%20Ergebnis%20zur%C3%BCckgeben.%20Mit%20der%20letzten%20Option%20%C3%A4hnelt%20er%20zwar%20den%20anderen%20Web%20Workern%2C%20die%20du%20dir%20angesehen%20hast%2C%20aber%20du%20solltest%20Service%20Worker%20nicht%20nur%20deshalb%20einsetzen%2C%20um%20rechenintensive%20Arbeit%20auf%20einen%20anderen%20Thread%20auszulagern.%5C%5CnService%20Worker%20stellen%20eine%20gr%C3%B6%C3%9Fere%20API%20zur%20Verf%C3%BCgung%20als%20die%20der%20anderen%20Web%20Worker%2C%20obwohl%20ihr%20prim%C3%A4rer%20Anwendungsfall%20nicht%20darin%20besteht%2C%20schwere%20Berechnungen%20vom%20Hauptthread%20zu%20entlasten.%20Service%20Worker%20sind%20sicherlich%20so%20komplex%2C%20dass%20ihnen%20ganze%20B%C3%BCcher%20gewidmet%20sind.%20Da%20das%20Hauptziel%20dieses%20Buches%20jedoch%20darin%20besteht%2C%20dir%20die%20Multithreading-F%C3%A4higkeiten%20von%20JavaScript%20zu%20vermitteln%2C%20werden%20wir%20sie%20nicht%20in%20ihrer%20Gesamtheit%20behandeln.%20Es%20gibt%20zum%20Beispiel%20eine%20ganze%20Push-API%20f%C3%BCr%20den%20Empfang%20von%20Nachrichten%2C%20die%20vom%20Server%20an%20den%20Browser%20gesendet%20werden%2C%20die%20wir%20nicht%20behandeln%20werden.%5C%5CnGenau%20wie%20die%20anderen%20Web%20Worker%20kann%20ein%20Service%20Worker%20nicht%20auf%20das%20DOM%20zugreifen.%20Er%20kann%20auch%20keine%20blockierenden%20Anfragen%20stellen.%20Zum%20Beispiel%20ist%20es%20nicht%20erlaubt%2C%20das%20dritte%20Argument%20von%20%60XMLHttpRequest%23open()%60%20auf%20%60false%60%20zu%20setzen%2C%20was%20die%20Codeausf%C3%BChrung%20blockieren%20w%C3%BCrde%2C%20bis%20die%20Anfrage%20erfolgreich%20ist%20oder%20ein%20Timeout%20eintritt.%20Browser%20lassen%20Service%20Worker%20nur%20auf%20einer%20Webseite%20laufen%2C%20die%20%C3%BCber%20das%20HTTPS-Protokoll%20bereitgestellt%20wurde.%20Zum%20Gl%C3%BCck%20f%C3%BCr%20uns%20gibt%20es%20eine%20bemerkenswerte%20Ausnahme%3A%20%60localhost%60%20kann%20Service%20Worker%20%C3%BCber%20HTTP%20laden.%20Das%20soll%20die%20lokale%20Entwicklung%20erleichtern.%20Firefox%20l%C3%A4sst%20keine%20Service%20Worker%20zu%2C%20wenn%20die%20Funktion%20Private%20Browsing%20verwendet%20wird.%20Chrome%20hingegen%20l%C3%A4sst%20Service%20Worker%20zu%2C%20wenn%20du%20seine%20Inkognito-Funktion%20nutzt.%20Allerdings%20kann%20ein%20Service%20Worker%20nicht%20zwischen%20einem%20normalen%20und%20einem%20Inkognito-Fenster%20kommunizieren.%5C%5CnSowohl%20Firefox%20als%20auch%20Chrome%20haben%20im%20Inspektor%20ein%20Anwendungs-Panel%2C%20das%20einen%20Bereich%20f%C3%BCr%20Service%20Worker%20enth%C3%A4lt.%20Dort%20kannst%20du%20alle%20Service%20Worker%20sehen%2C%20die%20mit%20der%20aktuellen%20Seite%20verkn%C3%BCpft%20sind%2C%20und%20eine%20sehr%20wichtige%20Entwicklungsma%C3%9Fnahme%20durchf%C3%BChren%3A%20die%20Aufhebung%20der%20Registrierung%2C%20mit%20der%20du%20den%20Zustand%20des%20Browsers%20wiederherstellen%20kannst%2C%20bevor%20der%20Worker%20registriert%20wurde.%20Leider%20bieten%20diese%20Browser-Panels%20in%20den%20aktuellen%20Browser-Versionen%20keine%20M%C3%B6glichkeit%2C%20in%20die%20JavaScript-Inspektoren%20f%C3%BCr%20die%20Service%20Worker%20zu%20springen.%5C%5Cn%23%23%23%20Debugging%20von%20Service%20Workern%5C%5CnUm%20in%20die%20Inspektor-Panels%20f%C3%BCr%20deine%20Service-Worker-Instanzen%20zu%20gelangen%2C%20musst%20du%20woanders%20hingehen.%20%C3%96ffne%20in%20Firefox%20die%20Adressleiste%20und%20besuche%20_about%3Adebugging%23%2Fruntime%2Fthis-firefox_.%20Scrolle%20nach%20unten%20zu%20den%20Service%20Workern%20und%20alle%20Worker%2C%20die%20du%20heute%20erstellt%20hast%2C%20sollten%20unten%20sichtbar%20sein.%20F%C3%BCr%20Chrome%20gibt%20es%20zwei%20verschiedene%20Seiten%2C%20um%20Zugriff%20auf%20die%20Service%20Worker%20des%20Browsers%20zu%20erhalten.%20Die%20robustere%20Seite%20befindet%20sich%20unter%20_chrome%3A%2F%2Fserviceworker-internals%2F_.%20Sie%20enth%C3%A4lt%20eine%20Auflistung%20der%20Service%20Worker%2C%20ihren%20Status%20und%20grundlegende%20Log-Ausgaben.%20Die%20andere%20Seite%20befindet%20sich%20unter%20_chrome%3A%2F%2Finspect%2F%23service-workers_%20und%20enth%C3%A4lt%20viel%20weniger%20Informationen.%5C%5CnJetzt%2C%20wo%20du%20einige%20der%20Probleme%20mit%20Service%20Workern%20kennst%2C%20kannst%20du%20einen%20aufbauen.%5C%5Cn%23%23%23%20Service%20Worker%20Hello%20World%5C%5CnIn%20diesem%20Abschnitt%20baust%20du%20einen%20sehr%20einfachen%20Service%20Worker%2C%20der%20alle%20HTTP-Anfragen%20abf%C3%A4ngt%2C%20die%20von%20einer%20einfachen%20Webseite%20gesendet%20werden.%20Die%20meisten%20Anfragen%20werden%20unver%C3%A4ndert%20an%20den%20Server%20weitergeleitet.%20Anfragen%2C%20die%20an%20eine%20bestimmte%20Ressource%20gerichtet%20sind%2C%20geben%20jedoch%20einen%20Wert%20zur%C3%BCck%2C%20der%20vom%20Service%20Worker%20selbst%20berechnet%20wird.%20Die%20meisten%20Service%20Worker%20w%C3%BCrden%20stattdessen%20eine%20Menge%20Cache-Abfragen%20durchf%C3%BChren%2C%20aber%20auch%20hier%20geht%20es%20darum%2C%20Service%20Worker%20aus%20einer%20Multithreading-Perspektive%20zu%20zeigen.%5C%5CnDie%20erste%20Datei%2C%20die%20du%20brauchst%2C%20ist%20wieder%20eine%20HTML-Datei.%20Erstelle%20ein%20neues%20Verzeichnis%20mit%20dem%20Namen%20_ch2-service-workers%2F_.%20In%20diesem%20Verzeichnis%20erstellst%20du%20dann%20eine%20Datei%20mit%20dem%20Inhalt%20aus%20Beispiel%202-8.%5C%5Cn**Beispiel%202-8.%20_ch2-service-workers%2Findex.html_**%5C%5Cn%60%60%60html%5C%5Cn%3Chtml%3E%5C%5Cn%20%20%3Chead%3E%5C%5Cn%20%20%20%20%3Ctitle%3EService%20Workers%20Example%3C%2Ftitle%3E%5C%5Cn%20%20%20%20%3Cscript%20src%3D%5C%5C%5C%22main.js%5C%5C%5C%22%3E%3C%2Fscript%3E%5C%5Cn%20%20%3C%2Fhead%3E%5C%5Cn%3C%2Fhtml%3E%5C%5Cn%60%60%60%5C%5CnDies%20ist%20eine%20recht%20einfache%20Datei%2C%20die%20nur%20die%20JavaScript-Datei%20deiner%20Anwendung%20l%C3%A4dt%2C%20die%20als%20n%C3%A4chstes%20kommt.%20Erstelle%20eine%20Datei%20namens%20_main.js_%20und%20f%C3%BCge%20den%20Inhalt%20aus%20Beispiel%202-9%20hinzu.%5C%5Cn**Beispiel%202-9.%20_ch2-service-workers%2Fmain.js_**%5C%5Cn%60%60%60javascript%5C%5Cnnavigator.serviceWorker.register(%5C%5C%5C%22%2Fsw.js%5C%5C%5C%22%2C%20%7B%5C%5Cn%20%20%2F%2F%201%5C%5Cn%20%20scope%3A%20%5C%5C%5C%22%2F%5C%5C%5C%22%2C%5C%5Cn%7D)%5C%5Cnnavigator.serviceWorker.oncontrollerchange%20%3D%20()%20%3D%3E%20%7B%5C%5Cn%20%20%2F%2F%202%5C%5Cn%20%20console.log(%5C%5C%5C%22controller%20change%5C%5C%5C%22)%5C%5Cn%7D%5C%5Cnasync%20function%20makeRequest()%20%7B%5C%5Cn%20%20%2F%2F%203%5C%5Cn%20%20const%20result%20%3D%20await%20fetch(%5C%5C%5C%22%2Fdata.json%5C%5C%5C%22)%5C%5Cn%20%20const%20payload%20%3D%20await%20result.json()%5C%5Cn%20%20console.log(payload)%5C%5Cn%7D%5C%5Cn%60%60%60%5C%5Cn1.%20Registriert%20den%20Service%20Worker%20und%20legt%20den%20Bereich%20fest.%5C%5Cn2.%20H%C3%B6rt%20auf%20ein%20%60controllerchange%60%20Ereignis.%5C%5Cn3.%20Funktion%20zum%20Ausl%C3%B6sen%20der%20Anfrage.%5C%5CnJetzt%20werden%20die%20Dinge%20ein%20wenig%20interessant.%20Das%20erste%2C%20was%20in%20dieser%20Datei%20passiert%2C%20ist%2C%20dass%20der%20Service%20Worker%20erstellt%20wird.%20Anders%20als%20bei%20den%20anderen%20Webworkern%2C%20mit%20denen%20du%20gearbeitet%20hast%2C%20verwendest%20du%20nicht%20das%20Schl%C3%BCsselwort%20%60new%60%20mit%20einem%20Konstruktor.%20Stattdessen%20h%C3%A4ngt%20dieser%20Code%20von%20dem%20%60navigator.serviceWorker%60%20Objekt%20ab%2C%20um%20den%20Worker%20zu%20erstellen.%20Das%20erste%20Argument%20ist%20der%20Pfad%20zu%20der%20JavaScript-Datei%2C%20die%20als%20Service%20Worker%20fungiert.%20Das%20zweite%20Argument%20ist%20ein%20optionales%20Konfigurationsobjekt%2C%20das%20eine%20einzelne%20%60scope%60%20Eigenschaft%20unterst%C3%BCtzt.%5C%5Cn%60scope%60%20stellt%20das%20Verzeichnis%20f%C3%BCr%20den%20aktuellen%20Ursprung%20dar%2C%20in%20dem%20alle%20HTML-Seiten%2C%20die%20darin%20geladen%20werden%2C%20ihre%20Anfragen%20durch%20den%20Service%20Worker%20leiten.%20Standardm%C3%A4%C3%9Fig%20ist%20der%20Wert%20%60scope%60%20derselbe%20wie%20das%20Verzeichnis%2C%20aus%20dem%20der%20Service%20Worker%20geladen%20wird.%20In%20diesem%20Fall%20bezieht%20sich%20der%20Wert%20_%2F_%20auf%20das%20Verzeichnis%20_index.html_.%20Da%20sich%20_sw.js_%20im%20selben%20Verzeichnis%20befindet%2C%20h%C3%A4tten%20wir%20den%20Bereich%20auch%20weglassen%20k%C3%B6nnen%20und%20es%20h%C3%A4tte%20sich%20genauso%20verhalten.%5C%5CnSobald%20der%20Service%20Worker%20f%C3%BCr%20die%20Seite%20installiert%20ist%2C%20werden%20alle%20ausgehenden%20HTTP-Anfragen%20%C3%BCber%20den%20Service%20Worker%20gesendet.%20Das%20gilt%20auch%20f%C3%BCr%20Anfragen%2C%20die%20an%20andere%20Herkunftsl%C3%A4nder%20gerichtet%20sind.%20Da%20der%20Geltungsbereich%20f%C3%BCr%20diese%20Seite%20auf%20das%20oberste%20Verzeichnis%20des%20Ursprungs%20festgelegt%20ist%2C%20muss%20jede%20HTML-Seite%2C%20die%20in%20diesem%20Ursprung%20ge%C3%B6ffnet%20wird%2C%20%C3%BCber%20den%20Service%20Worker%20Anfragen%20nach%20Assets%20stellen.%20W%C3%A4re%20%60scope%60%20auf%20_%2Ffoo_%20eingestellt%2C%20w%C3%A4re%20eine%20Seite%2C%20die%20unter%20_%2Fbar.html_%20ge%C3%B6ffnet%20wird%2C%20vom%20Service%20Worker%20nicht%20betroffen%2C%20eine%20Seite%20unter%20_%2Ffoo%2Fbaz.html_%20hingegen%20schon.%5C%5CnAls%20N%C3%A4chstes%20wird%20dem%20Objekt%20%60navigator.serviceWorker%60%20ein%20Listener%20f%C3%BCr%20das%20Ereignis%20%60controllerchange%60%20hinzugef%C3%BCgt.%20Wenn%20dieser%20Listener%20ausgel%C3%B6st%20wird%2C%20wird%20eine%20Meldung%20auf%20der%20Konsole%20ausgegeben.%20Diese%20Meldung%20dient%20nur%20zur%20Fehlersuche%2C%20wenn%20ein%20Service%20Worker%20die%20Kontrolle%20%C3%BCber%20eine%20geladene%20Seite%20%C3%BCbernimmt%2C%20die%20sich%20im%20Zust%C3%A4ndigkeitsbereich%20des%20Workers%20befindet.%5C%5CnSchlie%C3%9Flich%20wird%20eine%20Funktion%20namens%20%60makeRequest()%60%20definiert.%20Diese%20Funktion%20stellt%20eine%20%60GET%60%20Anfrage%20an%20den%20Pfad%20_%2Fdata.json_%2C%20dekodiert%20die%20Antwort%20als%20JavaScript%20Object%20Notation%20(JSON)%20und%20gibt%20das%20Ergebnis%20aus.%20Wie%20du%20vielleicht%20bemerkt%20hast%2C%20gibt%20es%20keine%20Verweise%20auf%20diese%20Funktion.%20Stattdessen%20wirst%20du%20sie%20sp%C3%A4ter%20manuell%20in%20der%20Konsole%20ausf%C3%BChren%2C%20um%20die%20Funktionalit%C3%A4t%20zu%20testen.%5C%5CnNachdem%20diese%20Datei%20fertig%20ist%2C%20kannst%20du%20jetzt%20den%20Service%20Worker%20selbst%20erstellen.%20Erstelle%20eine%20dritte%20Datei%20namens%20_sw.js_%20und%20f%C3%BCge%20den%20Inhalt%20aus%20Beispiel%202-10%20hinzu.%5C%5Cn**Beispiel%202-10.%20_ch2-service-workers%2Fsw.js_**%5C%5Cn%60%60%60javascript%5C%5Cnlet%20counter%20%3D%200%5C%5Cnself.oninstall%20%3D%20(event)%20%3D%3E%20%7B%5C%5Cn%20%20console.log(%5C%5C%5C%22service%20worker%20install%5C%5C%5C%22)%5C%5Cn%7D%5C%5Cnself.onactivate%20%3D%20(event)%20%3D%3E%20%7B%5C%5Cn%20%20console.log(%5C%5C%5C%22service%20worker%20activate%5C%5C%5C%22)%5C%5Cn%20%20event.waitUntil(self.clients.claim())%20%2F%2F%201%5C%5Cn%7D%5C%5Cnself.onfetch%20%3D%20(event)%20%3D%3E%20%7B%5C%5Cn%20%20console.log(%5C%5C%5C%22fetch%5C%5C%5C%22%2C%20event.request.url)%5C%5Cn%20%20if%20(event.request.url.endsWith(%5C%5C%5C%22%2Fdata.json%5C%5C%5C%22))%20%7B%5C%5Cn%20%20%20%20counter%2B%2B%5C%5Cn%20%20%20%20event.respondWith(%5C%5Cn%20%20%20%20%20%20%2F%2F%202%5C%5Cn%20%20%20%20%20%20new%20Response(JSON.stringify(%7B%20counter%20%7D)%2C%20%7B%5C%5Cn%20%20%20%20%20%20%20%20headers%3A%20%7B%5C%5Cn%20%20%20%20%20%20%20%20%20%20%5C%5C%5C%22Content-Type%5C%5C%5C%22%3A%20%5C%5C%5C%22application%2Fjson%5C%5C%5C%22%2C%5C%5Cn%20%20%20%20%20%20%20%20%7D%2C%5C%5Cn%20%20%20%20%20%20%7D)%5C%5Cn%20%20%20%20)%5C%5Cn%20%20%20%20return%5C%5Cn%20%20%7D%5C%5Cn%20%20%2F%2F%20fallback%20to%20normal%20HTTP%20request%5C%5Cn%20%20event.respondWith(fetch(event.request))%20%2F%2F%203%5C%5Cn%7D%5C%5Cn%60%60%60%5C%5Cn1.%20Erm%C3%B6glicht%20es%20dem%20Service%20Worker%2C%20die%20ge%C3%B6ffnete%20_index.html-Seite_%20zu%20beanspruchen.%5C%5Cn2.%20%C3%9Cberschreibung%20f%C3%BCr%20den%20Fall%2C%20dass%20_%2Fdata.json_%20angefordert%20wird.%5C%5Cn3.%20Andere%20URLs%20werden%20auf%20eine%20normale%20Netzwerkanfrage%20zur%C3%BCckgreifen.%5C%5CnDas%20erste%2C%20was%20in%20dieser%20Datei%20passiert%2C%20ist%2C%20dass%20die%20globale%20Variable%20%60counter%60%20auf%20Null%20gesetzt%20wird.%20Sp%C3%A4ter%2C%20wenn%20bestimmte%20Arten%20von%20Anfragen%20abgefangen%20werden%2C%20wird%20diese%20Zahl%20hochgez%C3%A4hlt.%20Dies%20ist%20nur%20ein%20Beispiel%2C%20um%20zu%20zeigen%2C%20dass%20der%20Service%20Worker%20l%C3%A4uft%3B%20in%20einer%20echten%20Anwendung%20solltest%20du%20niemals%20einen%20Zustand%2C%20der%20dauerhaft%20sein%20soll%2C%20auf%20diese%20Weise%20speichern.%20Rechne%20damit%2C%20dass%20Service%20Worker%20relativ%20h%C3%A4ufig%20starten%20und%20stoppen%2C%20und%20zwar%20auf%20eine%20Art%20und%20Weise%2C%20die%20schwer%20vorherzusagen%20ist%20und%20die%20sich%20je%20nach%20Browser-Implementierung%20unterscheidet.%5C%5CnDanach%20erstellen%20wir%20einen%20Handler%20f%C3%BCr%20das%20Ereignis%20%60install%60%2C%20indem%20wir%20%60self.oninstall%60%20eine%20Funktion%20zuweisen.%20Diese%20Funktion%20wird%20ausgef%C3%BChrt%2C%20wenn%20diese%20Version%20des%20Service%20Workers%20zum%20allerersten%20Mal%20im%20Browser%20installiert%20wird.%20In%20den%20meisten%20realen%20Anwendungen%20wird%20die%20Instanziierung%20in%20diesem%20Stadium%20durchgef%C3%BChrt.%20Zum%20Beispiel%20gibt%20es%20unter%20%60self.caches%60%20ein%20Objekt%2C%20mit%20dem%20man%20Caches%20konfigurieren%20kann%2C%20die%20das%20Ergebnis%20von%20Netzwerkanfragen%20speichern.%20Da%20diese%20einfache%20Anwendung%20jedoch%20nicht%20viel%20mit%20der%20Instanziierung%20zu%20tun%20hat%2C%20gibt%20sie%20nur%20eine%20Meldung%20aus%20und%20beendet%20sich.%5C%5CnAls%20N%C3%A4chstes%20folgt%20eine%20Funktion%20f%C3%BCr%2C%20die%20das%20Ereignis%20%60activate%60%20behandelt.%20Dieses%20Ereignis%20ist%20n%C3%BCtzlich%2C%20um%20Aufr%C3%A4umarbeiten%20durchzuf%C3%BChren%2C%20wenn%20neue%20Versionen%20des%20Service%20Workers%20eingef%C3%BChrt%20werden.%20In%20einer%20realen%20Anwendung%20geht%20es%20wahrscheinlich%20darum%2C%20alte%20Versionen%20von%20Caches%20abzubauen.%5C%5CnIn%20diesem%20Fall%20ist%20die%20Handler-Funktion%20%60activate%60%20und%20ruft%20die%20Methode%20%60self.clients.claim()%60%20auf.%20Der%20Aufruf%20dieser%20Methode%20erm%C3%B6glicht%20es%2C%20dass%20die%20Seite%2C%20die%20den%20Service%20Worker%20zuerst%20erstellt%20hat%2C%20also%20die%20Seite%20_index.html_%2C%20die%20du%20zum%20ersten%20Mal%20%C3%B6ffnest%2C%20vom%20Service%20Worker%20kontrolliert%20wird.%20Ohne%20diese%20Zeile%20w%C3%BCrde%20die%20Seite%20beim%20ersten%20Laden%20nicht%20vom%20Service%20Worker%20gesteuert%20werden.%20Wenn%20du%20die%20Seite%20jedoch%20aktualisierst%20oder%20_index.html_%20in%20einem%20anderen%20Tab%20%C3%B6ffnest%2C%20wird%20diese%20Seite%20kontrolliert.%5C%5CnDer%20Aufruf%20von%20%60self.clients.claim()%60%20gibt%20ein%20Versprechen%20zur%C3%BCck.%20Leider%20sind%20die%20in%20Service%20Workern%20verwendeten%20Event-Handler-Funktionen%20keine%20asynchronen%20Funktionen%2C%20die%20%60await%60%20Versprechen%20verarbeiten%20k%C3%B6nnen.%20Das%20Argument%20%60event%60%20ist%20jedoch%20ein%20Objekt%20mit%20einer%20%60.waitUntil()%60%20Methode%2C%20die%20mit%20einem%20Versprechen%20funktioniert.%20Sobald%20das%20Versprechen%2C%20das%20dieser%20Methode%20%C3%BCbergeben%20wird%2C%20aufgel%C3%B6st%20wird%2C%20kann%20die%20%60oninstall%60%20und%20%60onactivate%60%20(und%20sp%C3%A4ter%20%60onfetch%60)%20zu%20beenden.%20Wenn%20du%20diese%20Methode%20nicht%20aufrufst%2C%20wie%20im%20%60oninstall%60%20Handler%2C%20wird%20der%20Schritt%20als%20beendet%20angesehen%2C%20sobald%20die%20Funktion%20beendet%20ist.%5C%5CnDer%20letzte%20Event-Handler%20ist%20die%20Funktion%20%60onfetch%60.%20Diese%20Funktion%20ist%20die%20komplexeste%20und%20diejenige%2C%20die%20w%C3%A4hrend%20der%20Lebensdauer%20des%20Service%20Workers%20am%20h%C3%A4ufigsten%20aufgerufen%20wird.%20Dieser%20Handler%20wird%20jedes%20Mal%20aufgerufen%2C%20wenn%20eine%20Webseite%20unter%20der%20Kontrolle%20des%20Service%20Workers%20eine%20Netzwerkanfrage%20stellt.%20Er%20hei%C3%9Ft%20%60onfetch%60%2C%20um%20zu%20signalisieren%2C%20dass%20er%20mit%20der%20Funktion%20%60fetch()%60%20im%20Browser%20zusammenh%C3%A4ngt%2C%20obwohl%20das%20fast%20ein%20falscher%20Name%20ist%2C%20weil%20jede%20Netzwerkanfrage%20durch%20ihn%20geleitet%20wird.%20Wenn%20zum%20Beispiel%20sp%C3%A4ter%20ein%20Bild-Tag%20zur%20Seite%20hinzugef%C3%BCgt%20wird%2C%20w%C3%BCrde%20die%20Anfrage%20auch%20%60onfetch%60%20ausl%C3%B6sen.%5C%5CnDiese%20Funktion%20protokolliert%20zun%C3%A4chst%20eine%20Meldung%2C%20um%20zu%20best%C3%A4tigen%2C%20dass%20sie%20ausgef%C3%BChrt%20wird%2C%20und%20gibt%20die%20URL%20aus%2C%20die%20angefordert%20wird.%20Auch%20andere%20Informationen%20%C3%BCber%20die%20angeforderte%20Ressource%20sind%20verf%C3%BCgbar%2C%20z.%20B.%20Header%20und%20die%20HTTP-Methode.%20In%20einer%20realen%20Anwendung%20k%C3%B6nnen%20diese%20Informationen%20genutzt%20werden%2C%20um%20in%20einem%20Cache%20nachzuschlagen%2C%20ob%20die%20Ressource%20bereits%20existiert.%20Zum%20Beispiel%20k%C3%B6nnte%20eine%20%60GET%60%20Anfrage%20an%20eine%20Ressource%20innerhalb%20der%20aktuellen%20Herkunft%20aus%20dem%20Cache%20bedient%20werden%2C%20aber%20wenn%20sie%20nicht%20existiert%2C%20k%C3%B6nnte%20sie%20mit%20der%20Funktion%20%60fetch()%60%20angefordert%2C%20dann%20in%20den%20Cache%20eingef%C3%BCgt%20und%20anschlie%C3%9Fend%20an%20den%20Browser%20zur%C3%BCckgegeben%20werden.%5C%5CnIn%20diesem%20einfachen%20Beispiel%20wird%20lediglich%20gepr%C3%BCft%2C%20ob%20es%20sich%20um%20eine%20URL%20handelt%2C%20die%20auf%20_%2Fdata.json_%20endet.%20Ist%20dies%20nicht%20der%20Fall%2C%20wird%20der%20%60if%60%20Anweisungsteil%20%C3%BCbersprungen%20und%20die%20letzte%20Zeile%20der%20Funktion%20aufgerufen.%20Diese%20Zeile%20nimmt%20das%20Request-Objekt%20(eine%20Instanz%20von%20%60Request%60)%2C%20%C3%BCbergibt%20es%20an%20die%20Methode%20%60fetch()%60%2C%20die%20ein%20Versprechen%20zur%C3%BCckgibt%2C%20und%20%C3%BCbergibt%20dieses%20Versprechen%20an%20%60event.respondWith()%60.%20Die%20Methode%20%60fetch()%60%20l%C3%B6st%20ein%20Objekt%20auf%2C%20das%20f%C3%BCr%20die%20Antwort%20verwendet%20wird%2C%20die%20dann%20an%20den%20Browser%20%C3%BCbermittelt%20wird.%20Dies%20ist%20im%20Grunde%20ein%20sehr%20einfacher%20HTTP-Proxy.%5C%5CnWenn%20die%20Pr%C3%BCfung%20der%20URL%20_%2Fdata.json_%20jedoch%20bestanden%20wird%2C%20passiert%20etwas%20Komplizierteres.%20In%20diesem%20Fall%20wird%20die%20Variable%20%60counter%60%20inkrementiert%20und%20eine%20neue%20Antwort%20wird%20von%20Grund%20auf%20neu%20generiert%20(die%20eine%20Instanz%20von%20%60Response%60%20ist).%20In%20diesem%20Fall%20wird%20ein%20JSON-String%20erstellt%2C%20der%20den%20Wert%20%60counter%60%20enth%C3%A4lt.%20Dieser%20wird%20als%20erstes%20Argument%20an%20%60Response%60%20%C3%BCbergeben%2C%20das%20den%20Antwortk%C3%B6rper%20darstellt.%20Das%20zweite%20Argument%20enth%C3%A4lt%20Metainformationen%20%C3%BCber%20die%20Antwort.%20In%20diesem%20Fall%20wird%20der%20%60Content-Type%60%20Header%20auf%20%60application%2Fjson%60%20gesetzt%2C%20was%20dem%20Browser%20suggeriert%2C%20dass%20es%20sich%20bei%20der%20Antwort%20um%20einen%20JSON-Payload%20handelt.%5C%5CnNachdem%20du%20deine%20Dateien%20erstellt%20hast%2C%20navigiere%20mit%20deiner%20Konsole%20zu%20dem%20Verzeichnis%2C%20in%20dem%20du%20sie%20erstellt%20hast%2C%20und%20f%C3%BChre%20den%20folgenden%20Befehl%20aus%2C%20um%20einen%20weiteren%20Webserver%20zu%20starten%3A%5C%5Cn%60%60%60shell%5C%5Cn%24%20npx%20serve%20.%5C%5Cn%60%60%60%5C%5CnKopiere%20erneut%20die%20angegebene%20URL%2C%20%C3%B6ffne%20ein%20neues%20Webbrowser-Fenster%2C%20%C3%B6ffne%20den%20Inspektor%20und%20f%C3%BCge%20die%20URL%20ein%2C%20um%20die%20Seite%20zu%20besuchen.%20Du%20solltest%20diese%20Meldung%20in%20deiner%20Konsole%20sehen%20(und%20m%C3%B6glicherweise%20auch%20andere)%3A%5C%5Cn%60%60%60%5C%5Cncontroller%20change%20%20%20%20%20%20%20%20%20%20%20%20%20%20main.js%3A6%3A11%5C%5Cn%60%60%60%5C%5CnAls%20N%C3%A4chstes%20rufst%20du%20die%20Liste%20der%20in%20deinem%20Browser%20installierten%20Service%20Worker%20auf%2C%20indem%20du%20die%20oben%20beschriebene%20Technik%20anwendest.%20Im%20Inspektor%20solltest%20du%20die%20zuvor%20protokollierten%20Meldungen%20sehen%2C%20insbesondere%20diese%20beiden%3A%5C%5Cn%60%60%60%5C%5Cnservice%20worker%20install%20%20%20%20%20%20%20%20%20sw.js%3A4%3A11%5C%5Cnservice%20worker%20activate%20%20%20%20%20%20%20%20sw.js%3A8%3A11%5C%5Cn%60%60%60%5C%5CnAls%20N%C3%A4chstes%20wechselst%20du%20zur%C3%BCck%20zum%20Browserfenster.%20F%C3%BChre%20auf%20der%20Registerkarte%20Konsole%20des%20Inspektors%20die%20folgende%20Codezeile%20aus%3A%5C%5Cn%60%60%60javascript%5C%5CnmakeRequest()%5C%5Cn%60%60%60%5C%5CnDadurch%20wird%20die%20Funktion%20%60makeRequest()%60%20ausgef%C3%BChrt%2C%20die%20eine%20HTTP%20%60GET%60%20Anfrage%20an%20_%2Fdata.json_%20des%20aktuellen%20Ursprungs%20ausl%C3%B6st.%20Sobald%20der%20Vorgang%20abgeschlossen%20ist%2C%20solltest%20du%20die%20Meldung%20%60Object%20%7B%20counter%3A%201%20%7D%60%20in%20deiner%20Konsole%20sehen.%20Diese%20Nachricht%20wurde%20mit%20dem%20Service%20Worker%20erzeugt%20und%20die%20Anfrage%20wurde%20nie%20an%20den%20Webserver%20gesendet.%20Wenn%20du%20im%20Inspektor%20auf%20die%20Registerkarte%20Netzwerk%20wechselst%2C%20solltest%20du%20eine%20ganz%20normale%20Anfrage%20sehen%2C%20um%20die%20Ressource%20zu%20erhalten.%20Wenn%20du%20auf%20die%20Anfrage%20klickst%2C%20solltest%20du%20sehen%2C%20dass%20sie%20mit%20einem%20200-Statuscode%20geantwortet%20hat%20und%20der%20%60Content-Type%60%20-Header%20sollte%20ebenfalls%20auf%20%60application%2Fjson%60%20gesetzt%20sein.%20Soweit%20es%20die%20Webseite%20betrifft%2C%20hat%20sie%20eine%20normale%20HTTP-Anfrage%20gestellt.%20Aber%20du%20wei%C3%9Ft%20es%20besser.%5C%5CnWechsle%20zur%C3%BCck%20zur%20Inspektorkonsole%20des%20Service%20Workers.%20Hier%20solltest%20du%20sehen%2C%20dass%20eine%20dritte%20Nachricht%20mit%20den%20Details%20der%20Anfrage%20ausgegeben%20wurde.%20Auf%20unserem%20Rechner%20erhalten%20wir%20die%20folgende%20Meldung%3A%5C%5Cn%60%60%60%5C%5Cnfetch%20http%3A%2F%2Flocalhost%3A5000%2Fdata.json%20%20%20sw.js%3A13%3A11%5C%5Cn%60%60%60%5C%5CnAn%20diesem%20Punkt%20hast%20du%20erfolgreich%20eine%20HTTP-Anfrage%20von%20einer%20JavaScript-Umgebung%20abgefangen%2C%20eine%20Berechnung%20in%20einer%20anderen%20Umgebung%20durchgef%C3%BChrt%20und%20das%20Ergebnis%20an%20die%20Hauptumgebung%20zur%C3%BCckgegeben.%20Genau%20wie%20bei%20den%20anderen%20Webworkern%20wurde%20diese%20Berechnung%20in%20einem%20separaten%20Thread%20durchgef%C3%BChrt%2C%20in%20dem%20der%20Code%20parallel%20l%C3%A4uft.%20H%C3%A4tte%20der%20Service%20Worker%20einige%20sehr%20umfangreiche%20und%20langsame%20Berechnungen%20durchgef%C3%BChrt%2C%20h%C3%A4tte%20die%20Webseite%20andere%20Aktionen%20durchf%C3%BChren%20k%C3%B6nnen%2C%20w%C3%A4hrend%20sie%20auf%20die%20Antwort%20gewartet%20h%C3%A4tte.%5C%5Cn%3E%20**Tipp**%5C%5Cn%3E%5C%5Cn%3E%20In%20deinem%20ersten%20Browserfenster%20hast%20du%20vielleicht%20eine%20Fehlermeldung%20gesehen%2C%20dass%20der%20Versuch%2C%20die%20Datei%20_favicon.ico_%20herunterzuladen%2C%20fehlgeschlagen%20ist.%20Du%20fragst%20dich%20vielleicht%20auch%2C%20warum%20die%20Konsole%20des%20Shared%20Workers%20diese%20Datei%20nicht%20erw%C3%A4hnt.%20Das%20liegt%20daran%2C%20dass%20das%20Fenster%20zu%20dem%20Zeitpunkt%2C%20als%20es%20zum%20ersten%20Mal%20ge%C3%B6ffnet%20wurde%2C%20noch%20nicht%20unter%20der%20Kontrolle%20des%20Service%20Workers%20stand%2C%20so%20dass%20die%20Anfrage%20direkt%20%C3%BCber%20das%20Netzwerk%20erfolgte%20und%20der%20Worker%20umgangen%20wurde.%20Die%20Fehlersuche%20bei%20Service%20Workern%20kann%20verwirrend%20sein%2C%20und%20das%20ist%20einer%20der%20Vorbehalte%2C%20die%20du%20beachten%20solltest.%5C%5CnJetzt%2C%20wo%20du%20einen%20funktionierenden%20Service%20Worker%20gebaut%20hast%2C%20bist%20du%20bereit%2C%20einige%20der%20fortgeschrittenen%20Funktionen%20kennenzulernen%2C%20die%20zu%20bieten%20hat.%5C%5Cn%23%23%23%20Advanced%20Service%20Worker%20Concepts%5C%5CnService%20Worker%20sollen%20nur%20f%C3%BCr%20die%20Durchf%C3%BChrung%20asynchroner%20Operationen%20verwendet%20werden.%20Aus%20diesem%20Grund%20ist%20die%20%60localStorage%60%20API%2C%20die%20technisch%20gesehen%20beim%20Lesen%20und%20Schreiben%20blockiert%2C%20nicht%20verf%C3%BCgbar.%20Die%20asynchrone%20%60indexedDB%60%20API%20ist%20jedoch%20verf%C3%BCgbar.%20Die%20oberste%20Ebene%20%60await%60%20ist%20auch%20in%20den%20Service%20Workern%20deaktiviert.%5C%5CnWenn%20es%20darum%20geht%2C%20den%20Status%20zu%20verfolgen%2C%20wirst%20du%20meistens%20%60self.caches%60%20und%20%60indexedDB%60%20verwenden.%20Auch%20hier%20ist%20die%20Speicherung%20von%20Daten%20in%20einer%20globalen%20Variable%20nicht%20zuverl%C3%A4ssig.%20Wenn%20du%20deine%20Service%20Worker%20debuggst%2C%20kann%20es%20passieren%2C%20dass%20sie%20angehalten%20werden%20und%20du%20dann%20nicht%20mehr%20in%20den%20Inspektor%20springen%20kannst.%20In%20den%20Browsern%20gibt%20es%20eine%20Schaltfl%C3%A4che%2C%20mit%20der%20du%20den%20Worker%20wieder%20starten%20kannst%2C%20so%20dass%20du%20wieder%20in%20den%20Inspektor%20springen%20kannst.%20Durch%20dieses%20Stoppen%20und%20Starten%20wird%20der%20globale%20Status%20gel%C3%B6scht.%5C%5CnSkripte%20von%20Service%20Workern%20werden%20vom%20Browser%20ziemlich%20aggressiv%20zwischengespeichert.%20Wenn%20die%20Seite%20neu%20geladen%20wird%2C%20kann%20der%20Browser%20eine%20Anfrage%20f%C3%BCr%20das%20Skript%20stellen%2C%20aber%20wenn%20sich%20das%20Skript%20nicht%20ge%C3%A4ndert%20hat%2C%20wird%20es%20nicht%20f%C3%BCr%20einen%20Austausch%20in%20Betracht%20gezogen.%20Der%20Chrome-Browser%20bietet%20die%20M%C3%B6glichkeit%2C%20eine%20Aktualisierung%20des%20Skripts%20beim%20Neuladen%20der%20Seite%20auszul%C3%B6sen.%20Dazu%20navigierst%20du%20im%20Inspektor%20zur%20Registerkarte%20%5C%5C%5C%22Anwendung%5C%5C%5C%22%2C%20klickst%20auf%20%5C%5C%5C%22Service%20Workers%5C%5C%5C%22%20und%20dann%20auf%20das%20Kontrollk%C3%A4stchen%20%5C%5C%5C%22Beim%20Neuladen%20aktualisieren%5C%5C%5C%22.%5C%5CnJeder%20Service%20Worker%20durchl%C3%A4uft%20eine%20Zustands%C3%A4nderung%20vom%20Zeitpunkt%20seiner%20Gr%C3%BCndung%20bis%20zu%20dem%20Zeitpunkt%2C%20an%20dem%20er%20genutzt%20werden%20kann.%20Dieser%20Zustand%20ist%20innerhalb%20des%20Service%20Workers%20%C3%BCber%20die%20Eigenschaft%20%60self.serviceWorker.state%60%20abrufbar.%20Hier%20ist%20eine%20Liste%20der%20Phasen%2C%20die%20er%20durchl%C3%A4uft%3A%5C%5Cn-%20**geparst**%5C%5Cn%20%20-%20Dies%20ist%20der%20allerste%20Zustand%20des%20Service%20Workers.%20Zu%20diesem%20Zeitpunkt%20ist%20der%20JavaScript-Inhalt%20der%20Datei%20geparst%20worden.%20Dies%20ist%20eher%20ein%20interner%20Zustand%2C%20den%20du%20in%20deiner%20Anwendung%20wahrscheinlich%20nie%20erleben%20wirst.%5C%5Cn-%20**Die%20Installation%20von**%5C%5Cn%20%20-%20Die%20Installation%20hat%20begonnen%2C%20ist%20aber%20noch%20nicht%20abgeschlossen.%20Dies%20geschieht%20einmal%20pro%20Worker-Version.%20Dieser%20Zustand%20ist%20aktiv%2C%20nachdem%20%60oninstall%60%20aufgerufen%20wurde%20und%20bevor%20das%20%60event.respondWith()%60%20Versprechen%20aufgel%C3%B6st%20wurde.%5C%5Cn-%20**installiert**%5C%5Cn%20%20-%20An%20diesem%20Punkt%20ist%20die%20Installation%20abgeschlossen.%20Als%20n%C3%A4chstes%20wird%20der%20%60onactivate%60%20Handler%20aufgerufen.%20Bei%20meinen%20Tests%20habe%20ich%20festgestellt%2C%20dass%20die%20Service%20Worker%20so%20schnell%20von%20%60installing%60%20zu%20%60activating%60%20springen%2C%20dass%20ich%20den%20Zustand%20von%20%60installed%60%20nie%20sehe.%5C%5Cn-%20**Aktivieren%20von**%5C%5Cn%20%20-%20Dieser%20Zustand%20tritt%20ein%2C%20wenn%20%60onactivate%60%20aufgerufen%20wird%2C%20aber%20das%20%60event.respondWith()%60%20Versprechen%20noch%20nicht%20aufgel%C3%B6st%20wurde.%5C%5Cn-%20**aktiviert**%5C%5Cn%20%20-%20Die%20Aktivierung%20ist%20abgeschlossen%2C%20und%20der%20Worker%20ist%20bereit%2C%20seine%20Arbeit%20zu%20tun.%20An%20diesem%20Punkt%20werden%20die%20%60fetch%60%20Ereignisse%20abgefangen.%5C%5Cn-%20**Redundant**%5C%5Cn%20%20-%20Zu%20diesem%20Zeitpunkt%20wurde%20eine%20neuere%20Version%20des%20Skripts%20geladen%2C%20und%20das%20vorherige%20Skript%20ist%20nicht%20mehr%20erforderlich.%20Dies%20kann%20auch%20ausgel%C3%B6st%20werden%2C%20wenn%20der%20Download%20des%20Worker-Skripts%20fehlschl%C3%A4gt%2C%20es%20einen%20Syntaxfehler%20enth%C3%A4lt%20oder%20ein%20Fehler%20auftritt.%5C%5CnPhilosophisch%20gesehen%20sollten%20Service%20Worker%20als%20eine%20Form%20der%20progressiven%20Verbesserung%20behandelt%20werden.%20Das%20bedeutet%2C%20dass%20sich%20alle%20Webseiten%2C%20die%20sie%20verwenden%2C%20auch%20dann%20wie%20gewohnt%20verhalten%20sollten%2C%20wenn%20der%20Service%20Worker%20gar%20nicht%20verwendet%20wird.%20Das%20ist%20wichtig%2C%20denn%20es%20kann%20vorkommen%2C%20dass%20ein%20Browser%20Service%20Worker%20nicht%20unterst%C3%BCtzt%2C%20dass%20die%20Installation%20fehlschl%C3%A4gt%20oder%20dass%20datenschutzbewusste%20Nutzer%20sie%20ganz%20deaktivieren.%20Wenn%20du%20also%20nur%20Multithreading-F%C3%A4higkeiten%20in%20deine%20Anwendung%20einbauen%20willst%2C%20solltest%20du%20stattdessen%20einen%20der%20anderen%20Webworker%20w%C3%A4hlen.%5C%5CnDas%20globale%20Objekt%20%60self%60%2C%20das%20in%20Service%20Workern%20verwendet%20wird%2C%20ist%20eine%20Instanz%20von%20%60ServiceWorkerGlobalScope%60.%20Die%20Funktion%20%60importScripts()%60%20%2C%20die%20in%20anderen%20Web%20Workern%20verf%C3%BCgbar%20ist%2C%20steht%20auch%20in%20dieser%20Umgebung%20zur%20Verf%C3%BCgung.%20Wie%20bei%20den%20anderen%20Workern%20ist%20es%20auch%20hier%20m%C3%B6glich%2C%20Nachrichten%20an%20einen%20Service%20Worker%20zu%20senden%20und%20von%20ihm%20zu%20empfangen.%20Der%20gleiche%20%60self.onmessage%60%20Handler%20kann%20zugewiesen%20werden.%20Damit%20kann%20dem%20Service-Worker%20beispielsweise%20signalisiert%20werden%2C%20dass%20er%20eine%20Art%20Cache-Validierung%20durchf%C3%BChren%20soll.%20Auch%20f%C3%BCr%20Nachrichten%2C%20die%20auf%20diese%20Weise%20weitergegeben%20werden%2C%20gilt%20derselbe%20Klon-Algorithmus%2C%20den%20wir%20im%20Anhang%20besprechen.%5C%5CnBeim%20Debuggen%20deiner%20Service%20Worker%20und%20der%20Anfragen%2C%20die%20von%20deinem%20Browser%20gestellt%20werden%2C%20musst%20du%20das%20Caching%20im%20Auge%20behalten.%20Der%20Service%20Worker%20kann%20nicht%20nur%20Caches%20implementieren%2C%20die%20du%20programmatisch%20steuerst%2C%20sondern%20auch%20der%20Browser%20selbst%20muss%20mit%20dem%20regul%C3%A4ren%20Netzwerk-Caching%20umgehen.%20Das%20kann%20bedeuten%2C%20dass%20Anfragen%2C%20die%20von%20deinem%20Service%20Worker%20an%20den%20Server%20gesendet%20werden%2C%20nicht%20immer%20vom%20Server%20empfangen%20werden.%20Aus%20diesem%20Grund%20solltest%20du%20die%20Header%20%60Cache-Control%60%20und%20%60Expires%60%20im%20Hinterkopf%20behalten%20und%20darauf%20achten%2C%20dass%20die%20Werte%20absichtlich%20gesetzt%20werden.%5C%5CnEs%20gibt%20noch%20viel%20mehr%20Funktionen%20f%C3%BCr%20Service%20Worker%20als%20die%20in%20diesem%20Abschnitt%20beschriebenen.%20Mozilla%2C%20die%20Firma%2C%20die%20hinter%20Firefox%20steht%2C%20hat%20freundlicherweise%20eine%20Website%20mit%20einem%20Kochbuch%20zusammengestellt%2C%20in%20dem%20g%C3%A4ngige%20Strategien%20f%C3%BCr%20die%20Entwicklung%20von%20Service%20Workern%20beschrieben%20werden.%20Diese%20Website%20findest%20du%20unter%20https%3A%2F%2Fserviceworke.rs.%20Wir%20empfehlen%20dir%2C%20sie%20anzusehen%2C%20wenn%20du%20Service%20Worker%20in%20deiner%20n%C3%A4chsten%20Webanwendung%20einsetzen%20m%C3%B6chtest.%5C%5CnService%20Worker%20und%20die%20anderen%20Web%20Worker%2C%20die%20du%20dir%20angesehen%20hast%2C%20sind%20nicht%20ganz%20einfach%20zu%20handhaben.%20Zum%20Gl%C3%BCck%20gibt%20es%20einige%20praktische%20Bibliotheken%20und%20Kommunikationsmuster%2C%20die%20du%20implementieren%20kannst%2C%20um%20ihre%20Verwaltung%20zu%20vereinfachen.%5C%5Cn%23%23%23%20Dokumenten%C3%BCbergreifende%20Kommunikation%5C%5CnEs%20gibt%20noch%20andere%20M%C3%B6glichkeiten%2C%20JavaScript%20in%20Browsern%20mit%20mehreren%20Threads%20zu%20programmieren%2C%20ohne%20dass%20ein%20Webworker%20instanziiert%20werden%20muss.%20Dies%20ist%20m%C3%B6glich%2C%20indem%20man%20%C3%BCber%20verschiedene%20Browser-Kontexte%20kommuniziert%2C%20sowohl%20%C3%BCber%20vollst%C3%A4ndig%20ge%C3%B6ffnete%20Seiten%20als%20auch%20%C3%BCber%20Iframes.%20Die%20Browser%20stellen%20APIs%20zur%20Verf%C3%BCgung%2C%20die%20die%20Kommunikation%20zwischen%20diesen%20Seiten%20erm%C3%B6glichen.%5C%5CnDer%20erste%20Ansatz%20funktioniert%20durch%20das%20Einbetten%20von%20Iframes%20in%20eine%20Webseite%20oder%20durch%20das%20Erstellen%20eines%20Pop-up-Fensters%20und%20war%20schon%20verf%C3%BCgbar%2C%20bevor%20es%20Web%20Worker%20gab.%20Das%20%C3%BCbergeordnete%20Fenster%20kann%20einen%20Verweis%20auf%20das%20untergeordnete%20Fenster%20erhalten%20und%20dann%20eine%20%60.postMessage()%60%20Methode%20f%C3%BCr%20diesen%20Verweis%20aufrufen%2C%20um%20Nachrichten%20an%20das%20untergeordnete%20Fenster%20zu%20senden.%20Das%20Kind-Fenster%20kann%20dann%20auf%20%60message%60%20Ereignisse%20auf%20seinem%20%60window%60%20Objekt%20h%C3%B6ren.%20Das%20Child-Fenster%20kann%20auch%20Nachrichten%20an%20das%20Parent-Fenster%20zur%C3%BCckschicken.%20Dieses%20Muster%20stand%20wahrscheinlich%20Pate%20f%C3%BCr%20die%20Webworker-Schnittstellen.%5C%5CnDer%20zweite%20Ansatz%20ist%20ein%20bisschen%20universeller.%20Er%20erm%C3%B6glicht%20nicht%20nur%20die%20Kommunikation%20zwischen%20Pop-ups%20und%20Iframes%2C%20sondern%20auch%20zwischen%20allen%20Fenstern%2C%20die%20f%C3%BCr%20denselben%20Ursprung%20ge%C3%B6ffnet%20werden.%20Er%20geht%20sogar%20noch%20weiter%20und%20erm%C3%B6glicht%20auch%20die%20Kommunikation%20%C3%BCber%20Worker-Threads%20hinweg.%20Diese%20Kommunikation%20wird%20erreicht%2C%20indem%20eine%20neue%20Instanz%20von%20%60BroadcastChannel%60%20instanziiert%20und%20der%20Name%20eines%20Kanals%20als%20erstes%20Argument%20%C3%BCbergeben%20wird.%20Dieser%20Kanal%20erm%C3%B6glicht%20dann%20die%20Pub%2FSub-Kommunikation%20(Ver%C3%B6ffentlichen%20und%20Abonnieren).%20Das%20resultierende%20Objekt%20hat%20eine%20%60.postMessage()%60%20Methode%20und%20kann%20einen%20%60.onmessage%60%20Handler%20zugewiesen%20bekommen.%20Bei%20allen%20Objekten%2C%20die%20in%20verschiedenen%20Umgebungen%20auf%20diesem%20Kanal%20zuh%C3%B6ren%2C%20wird%20ihr%20Nachrichtenhandler%20aufgerufen%2C%20wenn%20eine%20Nachricht%20gepostet%20wurde.%20Die%20Instanz%20verf%C3%BCgt%20au%C3%9Ferdem%20%C3%BCber%20eine%20%60.close()%60%20Methode%2C%20um%20die%20Instanz%20vom%20Kanal%20zu%20trennen.%5C%5Cn%23%23%20Message%20Passing%20Abstractions%5C%5CnJeder%20der%20in%20diesem%20Kapitel%20von%20behandelten%20Web%20Worker%20verf%C3%BCgt%20%C3%BCber%20eine%20Schnittstelle%2C%20%C3%BCber%20die%20du%20Nachrichten%20an%20eine%20separate%20JavaScript-Umgebung%20weitergeben%20und%20von%20dort%20empfangen%20kannst.%20So%20kannst%20du%20Anwendungen%20erstellen%2C%20die%20JavaScript%20gleichzeitig%20auf%20mehreren%20Kernen%20ausf%C3%BChren%20k%C3%B6nnen.%5C%5CnAllerdings%20hast%20du%20bisher%20nur%20mit%20einfachen%2C%20erfundenen%20Beispielen%20gearbeitet%2C%20indem%20du%20einfache%20Strings%20weitergegeben%20und%20einfache%20Funktionen%20aufgerufen%20hast.%20Wenn%20es%20darum%20geht%2C%20gr%C3%B6%C3%9Fere%20Anwendungen%20zu%20erstellen%2C%20wird%20es%20wichtig%20sein%2C%20Nachrichten%20zu%20%C3%BCbermitteln%2C%20die%20skalierbar%20sind%2C%20und%20Code%20in%20Workern%20auszuf%C3%BChren%2C%20die%20skalierbar%20sind%2C%20und%20die%20Schnittstelle%20bei%20der%20Arbeit%20mit%20Workern%20zu%20vereinfachen%2C%20um%20m%C3%B6gliche%20Fehler%20zu%20reduzieren.%5C%5Cn%23%23%23%20The%20RPC%20Pattern%5C%5CnBisher%20hast%20du%20nur%20mit%20der%20%C3%9Cbergabe%20von%20einfachen%20Strings%20an%20die%20Worker%20vongearbeitet.%20Das%20ist%20zwar%20gut%2C%20um%20ein%20Gef%C3%BChl%20f%C3%BCr%20die%20F%C3%A4higkeiten%20von%20Web%20Workern%20zu%20bekommen%2C%20aber%20f%C3%BCr%20eine%20vollst%C3%A4ndige%20Anwendung%20ist%20es%20nicht%20geeignet.%5C%5CnNehmen%20wir%20zum%20Beispiel%20an%2C%20du%20hast%20einen%20Webworker%2C%20der%20eine%20einzige%20Sache%20macht%2C%20wie%20die%20Summe%20aller%20Quadratwurzelwerte%20von%201%20bis%201.000.000.%20Nun%2C%20du%20k%C3%B6nntest%20einfach%20%60postMessage()%60%20f%C3%BCr%20den%20Worker%20aufrufen%2C%20ohne%20Argumente%20zu%20%C3%BCbergeben%2C%20dann%20die%20langsame%20Logik%20im%20%60onmessage%60%20Handler%20ausf%C3%BChren%20und%20die%20Nachricht%20mit%20der%20%60postMessage()%60%20Funktion%20des%20Workers%20zur%C3%BCcksenden.%20Was%20aber%2C%20wenn%20der%20Worker%20auch%20die%20Fibonacci-Folge%20berechnen%20muss%3F%20In%20diesem%20Fall%20k%C3%B6nntest%20du%20einen%20String%20%C3%BCbergeben%2C%20einen%20f%C3%BCr%20%60square_sum%60%20und%20einen%20f%C3%BCr%20%60fibonacci%60.%20Aber%20was%20ist%2C%20wenn%20du%20Argumente%20brauchst%3F%20Nun%2C%20du%20k%C3%B6nntest%20%60square_sum%7Cnum%3A1000000%60%20%C3%BCbergeben.%20Aber%20was%20ist%2C%20wenn%20du%20Argumenttypen%20brauchst%3F%20Dann%20bekommst%20du%20vielleicht%20so%20etwas%20wie%20%60square_sum%7Cnum%3A1000000%60.%20Du%20siehst%20wahrscheinlich%2C%20worauf%20wir%20hinauswollen.%5C%5CnDas%20RPC-Muster%20(Remote%20Procedure%20Call)%20ist%20eine%20M%C3%B6glichkeit%2C%20eine%20Funktion%20und%20ihre%20Argumente%20zu%20repr%C3%A4sentieren%2C%20sie%20zu%20serialisieren%20und%20sie%20an%20ein%20entferntes%20Ziel%20zu%20%C3%BCbergeben%2C%20damit%20sie%20ausgef%C3%BChrt%20werden%20k%C3%B6nnen.%20Der%20String%20%60square_sum%7Cnum%3A1000000%60%20ist%20eigentlich%20eine%20Form%20von%20RPC%2C%20die%20wir%20versehentlich%20neu%20erstellt%20haben.%20Vielleicht%20kann%20er%20letztendlich%20in%20einen%20Funktionsaufruf%20wie%20%60squareNum(1000000)%60%20umgewandelt%20werden%2C%20der%20in%20%5C%5C%5C%22The%20Command%20Dispatcher%20Pattern%5C%5C%5C%22%20behandelt%20wird.%5C%5CnEs%20gibt%20noch%20ein%20weiteres%20komplexes%20Problem%2C%20um%20das%20sich%20eine%20Anwendung%20k%C3%BCmmern%20muss.%20Wenn%20der%20Hauptthread%20jeweils%20nur%20eine%20einzige%20Nachricht%20an%20einen%20Webworker%20sendet%2C%20wei%C3%9Ft%20du%2C%20wenn%20eine%20Nachricht%20vom%20Webworker%20zur%C3%BCckkommt%2C%20dass%20es%20die%20Antwort%20auf%20die%20Nachricht%20ist.%20Wenn%20du%20aber%20mehrere%20Nachrichten%20gleichzeitig%20an%20einen%20Webworker%20sendest%2C%20gibt%20es%20keine%20einfache%20M%C3%B6glichkeit%2C%20die%20Antworten%20zuzuordnen.%20Stell%20dir%20zum%20Beispiel%20eine%20Anwendung%20vor%2C%20die%20zwei%20Nachrichten%20an%20einen%20Webworker%20sendet%20und%20zwei%20Antworten%20erh%C3%A4lt%3A%5C%5Cn%60%60%60javascript%5C%5Cnworker.postMessage(%5C%5C%5C%22square_sum%7Cnum%3A4%5C%5C%5C%22)%5C%5Cnworker.postMessage(%5C%5C%5C%22fibonacci%7Cnum%3A33%5C%5C%5C%22)%5C%5Cnworker.onmessage%20%3D%20(result)%20%3D%3E%20%7B%5C%5Cn%20%20%2F%2F%20Which%20result%20belongs%20to%20which%20message%3F%5C%5Cn%20%20%2F%2F%20'3524578'%5C%5Cn%20%20%2F%2F%204.1462643%5C%5Cn%7D%5C%5Cn%60%60%60%5C%5CnGl%C3%BCcklicherweise%20gibt%20es%20einen%20Standard%20f%C3%BCr%20die%20Weitergabe%20von%20Nachrichten%20und%20die%20Erf%C3%BCllung%20des%20RPC-Musters%2C%20von%20dem%20du%20dich%20inspirieren%20lassen%20kannst.%20Dieser%20Standard%20hei%C3%9Ft%20JSON-RPC%20und%20ist%20ziemlich%20trivial%20zu%20implementieren.%20Dieser%20Standard%20definiert%20JSON-Darstellungen%20von%20Anfrage-%20und%20Antwortobjekten%20als%20%5C%5C%5C%22Notification%5C%5C%5C%22-Objekte%2C%20eine%20M%C3%B6glichkeit%2C%20die%20aufgerufene%20Methode%20und%20die%20Argumente%20in%20der%20Anfrage%20und%20das%20Ergebnis%20in%20der%20Antwort%20zu%20definieren%2C%20sowie%20einen%20Mechanismus%20zur%20Verkn%C3%BCpfung%20von%20Anfragen%20und%20Antworten.%20Es%20unterst%C3%BCtzt%20sogar%20Fehlerwerte%20und%20die%20Stapelverarbeitung%20von%20Anfragen.%20In%20diesem%20Beispiel%20wirst%20du%20nur%20mit%20einer%20Anfrage%20und%20einer%20Antwort%20arbeiten.%5C%5CnNimmt%20man%20die%20beiden%20Funktionsaufrufe%20aus%20unserem%20Beispiel%2C%20k%C3%B6nnte%20die%20JSON-RPC-Version%20dieser%20Anfragen%20und%20Antworten%20wie%20folgt%20aussehen%3A%5C%5Cn%60%60%60json%5C%5Cn%2F%2F%20worker.postMessage%5C%5Cn%7B%5C%5C%5C%22jsonrpc%5C%5C%5C%22%3A%20%5C%5C%5C%222.0%5C%5C%5C%22%2C%20%5C%5C%5C%22method%5C%5C%5C%22%3A%20%5C%5C%5C%22square_sum%5C%5C%5C%22%2C%20%5C%5C%5C%22params%5C%5C%5C%22%3A%20%5B4%5D%2C%20%5C%5C%5C%22id%5C%5C%5C%22%3A%201%7D%5C%5Cn%7B%5C%5C%5C%22jsonrpc%5C%5C%5C%22%3A%20%5C%5C%5C%222.0%5C%5C%5C%22%2C%20%5C%5C%5C%22method%5C%5C%5C%22%3A%20%5C%5C%5C%22fibonacci%5C%5C%5C%22%2C%20%5C%5C%5C%22params%5C%5C%5C%22%3A%20%5B33%5D%2C%20%5C%5C%5C%22id%5C%5C%5C%22%3A%202%7D%5C%5Cn%2F%2F%20worker.onmessage%5C%5Cn%7B%5C%5C%5C%22jsonrpc%5C%5C%5C%22%3A%20%5C%5C%5C%222.0%5C%5C%5C%22%2C%20%5C%5C%5C%22result%5C%5C%5C%22%3A%20%5C%5C%5C%223524578%5C%5C%5C%22%2C%20%5C%5C%5C%22id%5C%5C%5C%22%3A%202%7D%5C%5Cn%7B%5C%5C%5C%22jsonrpc%5C%5C%5C%22%3A%20%5C%5C%5C%222.0%5C%5C%5C%22%2C%20%5C%5C%5C%22result%5C%5C%5C%22%3A%204.1462643%2C%20%5C%5C%5C%22id%5C%5C%5C%22%3A%201%7D%5C%5Cn%60%60%60%5C%5CnIn%20diesem%20Fall%20gibt%20es%20jetzt%20eine%20klare%20Korrelation%20zwischen%20den%20Antwortnachrichten%20und%20der%20Anfrage.%5C%5CnJSON-RPC%20ist%20daf%C3%BCr%20gedacht%2C%20JSON%20als%20Kodierung%20zu%20verwenden%2C%20wenn%20Nachrichten%20serialisiert%20werden%2C%20insbesondere%20wenn%20sie%20%C3%BCber%20das%20Netzwerk%20gesendet%20werden.%20Diese%20%60jsonrpc%60%20Felder%20definieren%20die%20Version%20von%20JSON-RPC%2C%20an%20die%20sich%20die%20Nachricht%20h%C3%A4lt%2C%20was%20in%20einer%20Netzwerkumgebung%20sehr%20wichtig%20ist.%20Da%20Web%20Worker%20jedoch%20den%20strukturierten%20Klon-Algorithmus%20verwenden%20(siehe%20Anhang)%2C%20der%20die%20Weitergabe%20von%20JSON-kompatiblen%20Objekten%20erm%C3%B6glicht%2C%20k%C3%B6nnte%20eine%20App%20die%20Objekte%20einfach%20direkt%20weitergeben%2C%20ohne%20die%20Kosten%20f%C3%BCr%20die%20JSON-Serialisierung%20und%20Deserialisierung%20zu%20tragen.%20Au%C3%9Ferdem%20sind%20die%20Felder%20von%20%60jsonrpc%60%20im%20Browser%20m%C3%B6glicherweise%20nicht%20so%20wichtig%2C%20da%20du%20dort%20eine%20bessere%20Kontrolle%20%C3%BCber%20beide%20Enden%20des%20Kommunikationskanals%20hast.%5C%5CnMit%20diesen%20%60id%60%20Eigenschaften%2C%20die%20Request-%20und%20Response-Objekte%20korrelieren%2C%20ist%20es%20m%C3%B6glich%2C%20zu%20erkennen%2C%20welche%20Nachricht%20sich%20auf%20welche%20bezieht.%20Du%20wirst%20ein%5C%22%2C0%2Cnull%2Cnull%2Cnull%2Cnull%2C0%5D%2C%5B%5C%22id%5C%22%5D%2C%5B%5C%22c_929fc62a9a0a1be4%5C%22%2C%5C%22r_30a39ffcd3a8035c%5C%22%2C%5C%22rc_3941173d7c34bd5c%5C%22%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2C%5C%22AwAAAAAAAAAg4DUFz3Xz2P7vyYtVrBlM72BiXKdQZgAAAAA%5C%22%5D%2C%5C%22!NTalNm7NAAb9MTdP3TFCmqZ9SaY56Oc7ADQBEArZ1JsKbm8fsZ_DLN0eOtCs-fae76pHYrgG9enFmFlWnrEZ8Zcwz4GfSwgdLga8aA_FAgAAAMRSAAAACGgBB34AQTqHbJThsp_s31TcJD3lmJMx9NVaSmBPLAdBrB13sSP95KmMzDip1nDKtC9FEVMBGpsQfDDNCBQaLDE2TDlQVr10mQNro_avj6SjeNuH8yDxW_T6d40pgEtauVuPXlOOQUT632socHcVBfBuvZqvw7dmmvlUNl1Ka20TAb9GNXQspsKU09rD6MXDTEybRcX9RjlXw1tQCo7qagmT1xC4FiNYAm_qQ1zh5YU1wzHEVYnpac4_5O0GVkofhJJnaj5uQzPp4XuCpaIKdMHapHq4jjeBGaVBxT03myBVD1hWikg5k4pdUniX92XxhO2S0jOjocYV22J2shcIYYE2N4WZq1hjkI6fkT7cZbe9bSDjUT6Dg-jk68Zhbm12QA43WDY7sTr1bjCGiPWTddHoF-RMAKdr9EV8LHoUJkETy08WYTWsI9gCEA-NZ-Dy5-iLFR6vUMmY4WpLwDhg4aXVcDVwWm0el8TsNox1T8vRYbfiM0twk1HxBnRqi6-2ebgCU06Oi2nHZX6ITu64bjxlnhSeb4uzCtFYTZfxXi505KSZr6pD9C781c_0aeVWR2oiD8J5209Dy0OpU1cEYYe-Z_5gKEAubeeNBWG4FxgmFNqQvn9XPfAuqE_8IeLzOzqTwzk2tyd34UwIuhFqyi0YClQPQ-m3N3ND_CXDrgqsMQgt2NF9APYsR4qC-1clqjluMG5M0l44RfEikWkWqkPomweqgYTNEHfHGGHDhXI62Ud9EKlYgOLAwL0iFyPauR8SY1q61a1Wcspnf0fuStVS0kvrtMBMrJK2an1s-GtWUbwmuNOHhIXq7XVnrwwFcpsCj4Iv4QTAZOSefD7QI-EwgGQJfJi9iD52tgCjXCu6kpGpaRrKxl-63XZayNQo2wgwwY1sSTwLmqO0cvHVp91AWoeGSrnMIIocFbvBRxh4c4mzs2hMM4BkKu-ZdiL4XbzZIPrYNhl5vNxlVn1mkNFJLQc5WPPCgPlWZtBm3up2GrQvmTZIlLICXxt14_DYXkbAcMIMUVNAE4KudSbvzD1upl3kBvNJ3cOD4rgVxJ4ctdDJPo0y-3xUnff95b7My05ytMqm_N6QWo-AZpgFPjwPMCtJmreBWWaHM5-qBnlmjHu6wlqf1sFNaNpWdl89KcBRe7YHuVAUwmlBQXtv6A-S9UY0Xkrs5RVC3AAQhDkXVv6-C3TcZe8nhTj2abkdfaJt3HzfYqNYhI7vYQTR-YTLCFNintQciKAyWzoJNh4gapjvSBw%5C%22%2C%5C%22c2107b5f21c30395d7e416978a2fe951%5C%22%2Cnull%2C%5B1%5D%2C1%2Cnull%2Cnull%2C1%2C0%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2C%5B%5B5%5D%5D%2C0%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2C1%2Cnull%2Cnull%2C%5B4%5D%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2C%5B1%5D%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2C0%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2C%5C%22E2870D22-17BE-41CB-BF04-E4D711667347%5C%22%2Cnull%2C%5B%5D%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2C%5B%5D%5D%22%5D&at=ANHAVo0NWr-6a9gQm94YcY2w1GJF%3A1764247168697&",
    method: "POST",
  })
  console.log(response.ok)
  const chunks = makeStreamCompletionOrig(response, { model: "", sso: false })
  let lastContent = ""
  let fullContent = "" // Track the full accumulated content
  let partialContent = ""

  for await (const chunk of chunks) {
    let content = chunk.choices[0].delta.content
    // console.log(chunk.finish_reason)
    if (chunk.finish_reason === "done") {
      content = fullContent
      // console.log(content)
    }
    // Check if this is new content (not empty)
    if (content && content.trim() !== "") {
      // Clean invalid markdown code blocks from content using the dedicated function
      const cleanedContent = cleanInvalidMarkdownCodeBlocks(content, chunk)
      fullContent = content

      // Since each chunk contains the full content, we need to extract only the new part
      if (cleanedContent.length > lastContent.length) {
        // Extract only the new part that wasn't in the previous content
        partialContent = cleanedContent.substr(lastContent.length, cleanedContent.length - lastContent.length)

        // console.log({
        //   content: cleanedContent,
        //   lastContent,
        //   partialContent,
        //   contentLength: cleanedContent.length,
        //   lastContentLength: lastContent.length,
        //   isNewContent: true,
        // })
        // Update the full content and write only the new part
        process.stdout.write(partialContent)
      } else if (lastContent === "") {
        // First chunk, use the entire content
        partialContent = cleanedContent

        fullContent = cleanedContent
        // console.log({
        //   content: cleanedContent,
        //   lastContent,
        //   partialContent,
        //   contentLength: cleanedContent.length,
        //   lastContentLength: lastContent.length,
        //   isFirstChunk: true,
        // })
        process.stdout.write(partialContent)
      }
      // Always update lastContent to track what we've seen so far
      lastContent = cleanedContent
    }
  }
  console.log("")
}
main().catch((e) => console.error(e))
